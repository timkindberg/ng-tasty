{"version":3,"sources":["directive_parser.js"],"names":[],"mappings":"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","file":"/Users/tbosch/projects/angular2/modules/angular2/src/core/compiler/pipeline/directive_parser.js","sourcesContent":["import {isPresent, isBlank, BaseException, assertionsEnabled, RegExpWrapper} from 'angular2/src/facade/lang';\nimport {List, MapWrapper} from 'angular2/src/facade/collection';\nimport {DOM} from 'angular2/src/dom/dom_adapter';\nimport {SelectorMatcher} from '../selector';\nimport {CssSelector} from '../selector';\n\nimport {DirectiveMetadata} from '../directive_metadata';\nimport {DynamicComponent, Component, Viewport} from '../../annotations/annotations';\nimport {CompileStep} from './compile_step';\nimport {CompileElement} from './compile_element';\nimport {CompileControl} from './compile_control';\n\nvar PROPERTY_BINDING_REGEXP = RegExpWrapper.create('^ *([^\\\\s\\\\|]+)');\n\n/**\n * Parses the directives on a single element. Assumes ViewSplitter has already created\n * <template> elements for template directives.\n *\n * Fills:\n * - CompileElement#decoratorDirectives\n * - CompileElement#templateDirecitve\n * - CompileElement#componentDirective.\n *\n * Reads:\n * - CompileElement#propertyBindings (to find directives contained\n *   in the property bindings)\n * - CompileElement#variableBindings (to find directives contained\n *   in the variable bindings)\n */\nexport class DirectiveParser extends CompileStep {\n  _selectorMatcher:SelectorMatcher;\n  constructor(directives:List<DirectiveMetadata>) {\n    super();\n    var selector;\n\n    this._selectorMatcher = new SelectorMatcher();\n    for (var i=0; i<directives.length; i++) {\n      var directiveMetadata = directives[i];\n      selector = CssSelector.parse(directiveMetadata.annotation.selector);\n      this._selectorMatcher.addSelectables(selector, directiveMetadata);\n    }\n  }\n\n  process(parent:CompileElement, current:CompileElement, control:CompileControl) {\n    var attrs = current.attrs();\n    var classList = current.classList();\n\n    var cssSelector = new CssSelector();\n    var nodeName = DOM.nodeName(current.element);\n    cssSelector.setElement(nodeName);\n    for (var i=0; i < classList.length; i++) {\n      cssSelector.addClassName(classList[i]);\n    }\n\n    MapWrapper.forEach(attrs, (attrValue, attrName) => {\n      cssSelector.addAttribute(attrName, attrValue);\n    });\n\n    // Note: We assume that the ViewSplitter already did its work, i.e. template directive should\n    // only be present on <template> elements!\n    var isTemplateElement = DOM.isTemplateElement(current.element);\n\n    this._selectorMatcher.match(cssSelector, (selector, directive) => {\n      current.addDirective(checkDirectiveValidity(directive, current, isTemplateElement));\n    });\n  }\n}\n\n// check if the directive is compatible with the current element\nfunction checkDirectiveValidity(directive, current, isTemplateElement) {\n  var isComponent = directive.annotation instanceof Component || directive.annotation instanceof DynamicComponent;\n  var alreadyHasComponent = isPresent(current.componentDirective);\n\n  if (directive.annotation instanceof Viewport) {\n    if (!isTemplateElement) {\n      throw new BaseException(`Viewport directives need to be placed on <template> elements or elements ` +\n         `with template attribute - check ${current.elementDescription}`);\n    } else if (isPresent(current.viewportDirective)) {\n      throw new BaseException(`Only one viewport directive can be used per element - check ${current.elementDescription}`);\n    }\n  } else if (isTemplateElement) {\n    throw new BaseException(`Only template directives are allowed on template elements - check ${current.elementDescription}`);\n\n  } else if (isComponent && alreadyHasComponent) {\n    throw new BaseException(`Multiple component directives not allowed on the same element - check ${current.elementDescription}`);\n  }\n\n  return directive;\n}\n"]}